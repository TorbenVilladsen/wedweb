<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSVP</title>
    <link rel="stylesheet" href="styleRsvp.css">
    <link rel="icon" type="image/x-icon" href="../assets/images/logo.ico">

    <style>
        /* --- Security Styles --- */
        /* This ensures the page is blank until we verify the user */
        #access-denied {
            display: none;
            height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: #f4f4f4;
            font-family: sans-serif;
            padding: 20px;
        }

        /* Hide the main website content by default */
        #main-content {
            display: none;
        }

        /* --- Dynamic Text Styles --- */
        .dynamic-singular,
        .dynamic-plural {
            display: none;
        }
    </style>
</head>

<body>

    <div id="access-denied">
        <h1>Adgang nægtet</h1>
        <p>Vi kunne ikke finde din invitation.</p>
        <p>Gå venligst tilbage til forsiden eller scan din QR-kode igen.</p>
    </div>

    <div id="main-content">
        <main>
            <section class="hero">
                <div class="hero-header">
                    <a href="../" class="header-icon-link">
                        <img src="../assets/images/logo.png" alt="Site Icon" class="header-icon">
                    </a>

                    <nav class="navbar">
                        <button class="burger-button" id="burger-toggle">
                            <span class="burger-line"></span>
                            <span class="burger-line"></span>
                            <span class="burger-line"></span>
                        </button>

                        <ul>
                            <li><a href="../">Brylluppet</a></li>
                            <li><a href="../Information/">Praktisk information</a></li>
                            <li><a href="../Galleri/">Galleri</a></li>
                            <li class="active"><a href="index.html">RSVP</a></li>
                        </ul>
                    </nav>
                </div>
            </section>

            <div class="spacer layer1"></div>

            <section class="content">
                <h2 class="animate-from-left">Répondez s'il vous plaît</h2>

                <p class="animate-from-left delay-100">
                    <span class="dynamic-singular">
                        Ja, det er bare en fancy måde at sige du gerne må give svar om du kommer.
                    </span>
                    <span class="dynamic-plural">
                        Ja, det er bare en fancy måde at sige I gerne må give svar om I kommer.
                    </span>
                </p>

                <p class="animate-from-left delay-200">
                    Svar udbedes senest 1. juni, 2026. <br />
                    Man kan give svar ved at kontakte én af os på telefon (Anne: 20 86 37 50 eller Torben: 24 93 06 22)
                    eller skriv til os på anden vis. <br />
                    Alternativt er man også velkommen til at give svar via nedestående metode
                </p>

                <form class="rsvp-form animate-from-left delay-300">
                    <label for="comment">Skriv en besked eller kommentar, fx hvis man har nogle kostrestriktioner eller
                        andre forhold vi bør tage hensyn til:</label><br>
                    <textarea id="comment" name="comment" rows="4" placeholder="Skriv din besked her..."></textarea>

                    <div class="button-group">
                        <button type="button" class="accept">
                            <span class="dynamic-singular">Jaaa jeg kommer</span>
                            <span class="dynamic-plural">Jaaa vi kommer</span>
                        </button>

                        <button type="button" class="decline">Desværre ikke</button>
                    </div>
                </form>
            </section>
        </main>

        <footer>
            <p>© 2025 Anne & Torben. All rights reserved.</p>
        </footer>
    </div>
    <script src="../script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            const uid = params.get("uid");

            const mainContent = document.getElementById("main-content");
            const accessDenied = document.getElementById("access-denied");

            // List of Singular Guests
            const singular = [
                "A55wFTf", // Peter
                "58HBunqMnD11aC", // Inger Lise
                "9jTLnAp", // Mette
                "9jMQ9Ex", // Maria
                "3A92UG", // Thea
                "9cotLEC", // Laura
                "9QERPZW", // Julie
                "3w5XWTxE3t", // Maria
                "fE8UJcoN", // Lærke
                "3Z8geD6NM2", // Cecilie
                "e3jiZZYV", // Jesper
                "8c7ujQg", // Cille
                "9cosfLp", // Lasse
                "ZbNnoRLP", // Astrid
                "3BeNDE", // Ulla
                "3pc2L4fmoJ", // Joachim
                "3qL2GLen13", // Jørgen
                "DT7eM6UY7GE", // Johannes
                "9PimJu7", // Jakob
                "2vqB3R", // Knud
                "3tt3knWMnB", // Lasse
                "43hxsayMxw", // Peter
                "2yim4E", // Mads
                "test" // testperson
            ];

            // *** YOUR GOOGLE SCRIPT URL ***
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzBSFMocujtJ1e7K75mdvCNM8sol4CzP8EXI6aJjBqRvsj3Up133uidq_KjdozvOJ8/exec";

            // --- SECURITY CHECK ---
            if (!uid) {
                showAccessDenied();
                return;
            }

            try {
                const response = await fetch("../assets/guest.json");
                if (!response.ok) throw new Error("JSON not found");

                const guests = await response.json();

                if (guests[uid]) {
                    // === ACCESS GRANTED ===

                    // 1. Determine if Singular or Plural
                    const isSingular = singular.includes(uid);

                    // 2. Apply Logic to HTML Elements
                    const singularEls = document.querySelectorAll(".dynamic-singular");
                    const pluralEls = document.querySelectorAll(".dynamic-plural");

                    if (isSingular) {
                        // Show Singular, Hide Plural
                        singularEls.forEach(el => el.style.display = "inline");
                        pluralEls.forEach(el => el.style.display = "none");
                    } else {
                        // Hide Singular, Show Plural
                        singularEls.forEach(el => el.style.display = "none");
                        pluralEls.forEach(el => el.style.display = "inline");
                    }

                    // 3. Show Content & Update Links
                    accessDenied.style.display = "none";
                    mainContent.style.display = "flex";
                    updateLinks(uid);

                    // 4. Pass boolean 'isSingular' to setup function for the Success Message
                    setupRSVPButtons(uid, guests, isSingular);

                } else {
                    showAccessDenied();
                }
            } catch (err) {
                console.error("Verification failed:", err);
                showAccessDenied();
            }

            // --- RSVP FUNCTIONALITY ---
            function setupRSVPButtons(userId, guestList, isSingularGuest) {
                const form = document.querySelector(".rsvp-form");
                // 1. CAPTURE ORIGINAL HTML
                const originalFormHTML = form.innerHTML;

                // Storage key for this specific user
                const storageKey = `rsvp_status_${userId}`;

                // --- SEND LOGIC ---
                const sendRSVP = (answer) => {
                    const currentCommentBox = document.getElementById("comment");
                    const commentValue = currentCommentBox ? currentCommentBox.value : "";

                    form.innerHTML = "<p style='text-align:center; font-weight:bold; padding:20px;'>Sender dit svar...</p>";

                    const guestName = guestList[userId] ? guestList[userId].navn : "Ukendt Gæst";

                    const payload = {
                        uid: userId,
                        name: guestName,
                        answer: answer,
                        comment: commentValue
                    };

                    fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }
                    })
                        .then(() => {
                            localStorage.setItem(storageKey, answer);
                            showSuccessUI(answer);
                        })
                        .catch(err => {
                            console.error(err);
                            restoreForm();
                            alert("Der skete en fejl. Prøv venligst igen.");
                        });
                };

                // --- UI HELPERS ---

                const restoreForm = () => {
                    form.innerHTML = originalFormHTML;

                    // Re-apply singular/plural display logic to the restored button text
                    const singularEls = form.querySelectorAll(".dynamic-singular");
                    const pluralEls = form.querySelectorAll(".dynamic-plural");

                    if (isSingularGuest) {
                        singularEls.forEach(el => el.style.display = "inline");
                        pluralEls.forEach(el => el.style.display = "none");
                    } else {
                        singularEls.forEach(el => el.style.display = "none");
                        pluralEls.forEach(el => el.style.display = "inline");
                    }

                    attachListeners();
                };

                const attachListeners = () => {
                    const btnAccept = form.querySelector(".accept");
                    const btnDecline = form.querySelector(".decline");

                    if (btnAccept) btnAccept.addEventListener("click", () => sendRSVP("JA"));
                    if (btnDecline) btnDecline.addEventListener("click", () => sendRSVP("NEJ"));
                };

                const showSuccessUI = (answer) => {
                    // Logic for "dig" vs "jer"
                    const greeting = isSingularGuest ? "dig" : "jer";

                    const message = answer === "JA"
                        ? `Jubii! Vi glæder os til at se ${greeting}! ❤️`
                        : "Det er vi kede af, men tak for beskeden. ❤️";

                    form.innerHTML = `
                        <div style='text-align:center; padding: 20px; background-color: #f9f9f9; border-radius: 8px;'>
                            <h3>Tak for dit svar!</h3>
                            <p>${message}</p>
                            <button id="reset-rsvp" style="margin-top:15px; font-size:0.8rem; background:none; border:none; text-decoration:underline; cursor:pointer; color:#999;">
                                Ændre svar?
                            </button>
                        </div>`;

                    document.getElementById("reset-rsvp").addEventListener("click", () => {
                        localStorage.removeItem(storageKey);
                        restoreForm();
                    });
                };

                // --- INITIALIZATION ---
                const savedAnswer = localStorage.getItem(storageKey);
                if (savedAnswer) {
                    showSuccessUI(savedAnswer);
                } else {
                    attachListeners();
                }
            }

            // --- HELPER FUNCTIONS ---
            function showAccessDenied() {
                mainContent.style.display = "none";
                accessDenied.style.display = "flex";
            }

            function updateLinks(validUid) {
                document.querySelectorAll("a").forEach(link => {
                    const href = link.getAttribute("href");
                    if (!href || href.startsWith("mailto:") || (href.startsWith("http") && !href.includes("index.html"))) return;
                    try {
                        const url = new URL(link.href, window.location.origin);
                        url.searchParams.set("uid", validUid);
                        link.href = url.toString();
                    } catch (e) { console.log("Skipping link:", href); }
                });
            }

            // --- BURGER MENU LOGIC ---
            const burgerToggle = document.getElementById("burger-toggle");
            const navLinks = document.querySelector(".navbar ul");

            if (burgerToggle && navLinks) {
                const closeMenu = () => {
                    navLinks.classList.remove("nav-active");
                    burgerToggle.classList.remove("burger-active");
                };
                const toggleMenu = () => {
                    navLinks.classList.toggle("nav-active");
                    burgerToggle.classList.toggle("burger-active");
                };
                burgerToggle.addEventListener("click", toggleMenu);
                navLinks.addEventListener("click", (e) => {
                    if (e.target === navLinks) closeMenu();
                });
            }
        });
    </script>
</body>

</html>
