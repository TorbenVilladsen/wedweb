<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSVP</title>
    <link rel="stylesheet" href="styleRsvp.css">
    <link rel="icon" type="image/x-icon" href="../assets/images/logo.ico">

    <style>
        /* --- Security Styles --- */
        /* This ensures the page is blank until we verify the user */
        #access-denied {
            display: none;
            height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: #f4f4f4;
            font-family: sans-serif;
            padding: 20px;
        }

        /* Hide the main website content by default */
        #main-content {
            display: none;
        }
    </style>
</head>

<body>

    <div id="access-denied">
        <h1>Adgang nægtet</h1>
        <p>Vi kunne ikke finde din invitation.</p>
        <p>Gå venligst tilbage til forsiden eller scan din QR-kode igen.</p>
    </div>

    <div id="main-content">
        <main>
            <section class="hero">
                <div class="hero-header">
                    <a href="../Brylluppet/index.html" class="header-icon-link">
                        <img src="../assets/images/logo.png" alt="Site Icon" class="header-icon">
                    </a>

                    <nav class="navbar">
                        <button class="burger-button" id="burger-toggle">
                            <span class="burger-line"></span>
                            <span class="burger-line"></span>
                            <span class="burger-line"></span>
                        </button>

                        <ul>
                            <li><a href="../index.html">Brylluppet</a></li>
                            <li><a href="../Information/">Praktisk information</a></li>
                            <li><a href="../Galleri/">Galleri</a></li>
                            <li class="active"><a href="index.html">RSVP</a></li>
                        </ul>
                    </nav>
                </div>
            </section>

            <div class="spacer layer1"></div>

            <section class="content">
                <h1 class="animate-from-left">Répondez s'il vous plaît</h2>
                <p class="animate-from-left delay-100">
                    Ja, det er bare en fancy måde at sige I gerne må give svar om I kommer.
                </p>

                <p class="animate-from-left delay-200">
                    Svar udbedes senest 1. juni, 2026. <br />
                    Man kan give svar ved at kontakte én af os på telefon (Anne: 20 86 37 50 eller Torben: 24 93 06 22)
                    eller skriv til os på anden vis. <br />
                    Alternativt er man også velkommen til at give svar via nedestående metode
                </p>

                <form class="rsvp-form animate-from-left delay-300">
                    <label for="comment">Skriv en besked eller kommentar, fx hvis man har nogle kostrestriktioner eller
                        andre forhold vi bør tage hensyn til:</label><br>
                    <textarea id="comment" name="comment" rows="4" placeholder="Skriv din besked her..."></textarea>

                    <div class="button-group">
                        <button type="button" class="accept">Jaaa vi kommer</button>
                        <button type="button" class="decline">Desværre ikke</button>
                    </div>
                </form>
            </section>
        </main>

        <footer>
            <p>© 2025 Anne & Torben. All rights reserved.</p>
        </footer>
    </div>
    <script src="../script.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const uid = params.get("uid");

        const mainContent = document.getElementById("main-content");
        const accessDenied = document.getElementById("access-denied");

        // *** YOUR GOOGLE SCRIPT URL ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzBSFMocujtJ1e7K75mdvCNM8sol4CzP8EXI6aJjBqRvsj3Up133uidq_KjdozvOJ8/exec";

        // --- SECURITY CHECK ---
        if (!uid) {
            showAccessDenied();
            return;
        }

        try {
            const response = await fetch("../assets/guest.json");
            if (!response.ok) throw new Error("JSON not found");

            const guests = await response.json();

            if (guests[uid]) {
                // === ACCESS GRANTED ===
                accessDenied.style.display = "none";
                mainContent.style.display = "flex";
                updateLinks(uid);

                // Pass guests to the function
                setupRSVPButtons(uid, guests);

            } else {
                showAccessDenied();
            }
        } catch (err) {
            console.error("Verification failed:", err);
            showAccessDenied();
        }

        // --- RSVP FUNCTIONALITY ---
        function setupRSVPButtons(userId, guestList) {
            const form = document.querySelector(".rsvp-form");
            // 1. CAPTURE ORIGINAL HTML
            // We save exactly how the form looks now so we can restore it later
            const originalFormHTML = form.innerHTML;

            // Storage key for this specific user
            const storageKey = `rsvp_status_${userId}`;

            // --- SEND LOGIC ---
            // This function "remembers" the userId forever.
            const sendRSVP = (answer) => {
                // Find the comment box (we need to find it again in case form was reset)
                const currentCommentBox = document.getElementById("comment");
                const commentValue = currentCommentBox ? currentCommentBox.value : "";

                // Update UI to loading
                form.innerHTML = "<p style='text-align:center; font-weight:bold; padding:20px;'>Sender dit svar...</p>";

                const guestName = guestList[userId] ? guestList[userId].navn : "Ukendt Gæst";

                const payload = {
                    uid: userId,     // <--- This variable is locked in and cannot be wrong
                    name: guestName,
                    answer: answer,
                    comment: commentValue
                };

                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                })
                    .then(() => {
                        // Save to storage
                        localStorage.setItem(storageKey, answer);
                        // Show success message
                        showSuccessUI(answer);
                    })
                    .catch(err => {
                        console.error(err);
                        // If error, restore form so they can try again
                        restoreForm();
                        alert("Der skete en fejl. Prøv venligst igen.");
                    });
            };

            // --- UI HELPERS ---

            const restoreForm = () => {
                // 1. Put the HTML back
                form.innerHTML = originalFormHTML;

                // 2. We MUST re-attach the event listeners because the buttons are "new" elements now
                attachListeners();
            };

            const attachListeners = () => {
                const btnAccept = form.querySelector(".accept");
                const btnDecline = form.querySelector(".decline");

                if (btnAccept) btnAccept.addEventListener("click", () => sendRSVP("JA"));
                if (btnDecline) btnDecline.addEventListener("click", () => sendRSVP("NEJ"));
            };

            const showSuccessUI = (answer) => {
                const message = answer === "JA"
                    ? "Jubii! Vi glæder os til at se dig/jer! ❤️"
                    : "Det er vi kede af, men tak for beskeden. ❤️";

                form.innerHTML = `
                        <div style='text-align:center; padding: 20px; background-color: #f9f9f9; border-radius: 8px;'>
                            <h3>Tak for dit svar!</h3>
                            <p>${message}</p>
                            <button id="reset-rsvp" style="margin-top:15px; font-size:0.8rem; background:none; border:none; text-decoration:underline; cursor:pointer; color:#999;">
                                Ændre svar?
                            </button>
                        </div>`;

                // Logic for the reset button
                document.getElementById("reset-rsvp").addEventListener("click", () => {
                    localStorage.removeItem(storageKey);
                    restoreForm(); // Restores the form using the logic above
                });
            };

            // --- INITIALIZATION ---

            // Check if already answered
            const savedAnswer = localStorage.getItem(storageKey);
            if (savedAnswer) {
                showSuccessUI(savedAnswer);
            } else {
                attachListeners(); // If not answered, activate buttons
            }
        }

        // --- HELPER FUNCTIONS ---
        function showAccessDenied() {
            mainContent.style.display = "none";
            accessDenied.style.display = "flex";
        }

        function updateLinks(validUid) {
            document.querySelectorAll("a").forEach(link => {
                const href = link.getAttribute("href");
                if (!href || href.startsWith("mailto:") || (href.startsWith("http") && !href.includes("index.html"))) return;
                try {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set("uid", validUid);
                    link.href = url.toString();
                } catch (e) { console.log("Skipping link:", href); }
            });
        }

        // --- BURGER MENU LOGIC ---
        const burgerToggle = document.getElementById("burger-toggle");
        const navLinks = document.querySelector(".navbar ul");

        if (burgerToggle && navLinks) {
            const closeMenu = () => {
                navLinks.classList.remove("nav-active");
                burgerToggle.classList.remove("burger-active");
            };
            const toggleMenu = () => {
                navLinks.classList.toggle("nav-active");
                burgerToggle.classList.toggle("burger-active");
            };
            burgerToggle.addEventListener("click", toggleMenu);
            navLinks.addEventListener("click", (e) => {
                if (e.target === navLinks) closeMenu();
            });
        }
    });
</script>
</body>

</html>
